<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Advanced Installation</h1>
                </header>
            
            <article>
                
<p>Deep learning involves a huge amount of matrix multiplications, and <strong>Graphic Processing Units</strong> (<strong>GPUs</strong>) are a very important aspect when one begins to learn deep learning. Without a GPU, the experiment process may take a day or more. With a good GPU, we can quickly iterate over deep learning networks and large training datasets, and run multiple experiments in a short amount of time. With TensorFlow, we can work on a single GPU or even multiple GPUs with ease. However, most machine learning platform installations are very complicated once GPUs get involved.</p>
<p>In this chapter, we are going to discuss GPUs and focus on a step-by-step CUDA setup and a GPU-based TensorFlow installation. We will start by installing Nvidia drivers, the CUDA Toolkit, and the cuDNN library. Then, we will install GPU-enabled TensorFlow with <kbd>pip</kbd>. Finally, we show how to use Anaconda to simplify the installation process even further.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installation</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will work on an Ubuntu 16.06 computer with a Nvidia Titan X GPU.</p>
<div class="packt_tip">We suggest that you use Ubuntu 14.04 or 16.06 to avoid further issues.</div>
<p>The choice of GPU is beyond the scope of this chapter. However, you must choose a Nvidia device with a high memory capacity in order to take full advantage of the GPU when compared to a CPU. Currently, AMD GPUs are not officially supported by TensorFlow and most other deep learning frameworks. At the time of writing, Windows can use Tensorflow with GPU on Python 3.5 or Python 3.6. However, Tensorflow dropped the support for GPU on macOS from Tensorflow 1.2. If you are using Windows, we suggest that you follow the official tutorial for Windows at the following link: <a href="https://www.tensorflow.org/install/install_windows"><span class="URLPACKT">https://www.tensorflow.org/install/install_windows</span></a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing Nvidia driver</h1>
                </header>
            
            <article>
                
<p>There are many ways to install Nvidia drivers in Ubuntu. In this section, we will show you the easiest approach by using Proprietary GPU Drivers PPA, which offers stable proprietary Nvidia graphics driver updates.</p>
<p>First, open your terminal and run the following commands to add the <kbd>PPA</kbd> to Ubuntu:</p>
<pre><strong>sudo add-apt-repository ppa:graphics-drivers/ppa</strong>
<strong>sudo apt update</strong>  </pre>
<p>Now, we need to choose a version of Nvidia driver to install. Run the following command to see the latest version of your machine:</p>
<pre><strong>sudo apt-cache search nvidia</strong></pre>
<p>The result of the preceding command may look like this:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="554" width="667" class=" image-border" src="assets/7c197318-f268-4537-b70a-36f099a7ba43.png"/></div>
<p>As you can see, the latest driver is 375.66 on my machine, which is on the line with the text NVIDIA binary driver. Now, we can install Nvidia driver version 375.66 with the following command:</p>
<pre class="mce-root"><strong>sudo apt-get install nvidia-375<br/></strong></pre>
<p class="mce-root">The result of the preceding command may look like this:<strong><br/></strong></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="452" width="646" class=" image-border" src="assets/bd81ea64-17be-4d50-8668-33f5e5ef3880.png"/></div>
<p>When the installation is finished, you should see the following screen:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="516" width="625" class=" image-border" src="assets/cc36071a-d96b-4516-9888-5006cf7227c4.png"/></div>
<p>Now, we will install the CUDA toolkit from Nvidia.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing the CUDA toolkit</h1>
                </header>
            
            <article>
                
<p>First, we will need to open the Nvidia website to download the <span class="packt_screen">CUDA toolkit</span>. Navigate to <a href="https://developer.nvidia.com/cuda-downloads"><span class="URLPACKT">https://developer.nvidia.com/cuda-downloads</span></a>. You will see the following screen:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="553" width="683" class=" image-border" src="assets/8e04ef1b-0914-4002-9c93-28531297542c.png"/></div>
<p>Then, select <span class="packt_screen">Linux</span> | <span class="packt_screen">x86_64</span> | <span class="packt_screen">Ubuntu </span>| <span class="packt_screen">16.04</span> | <span class="packt_screen">runfile(local)</span>, as shown in the following screenshot:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="787" width="665" class=" image-border" src="assets/15b9367e-9e39-4d9f-933a-a683f1bc8847.png"/></div>
<p>Next, click on the <span class="packt_screen">Download (1.4 GB)</span> button to download the installer. The installer size is 1.4 GB and it will take a while to finish downloading. After that, open your terminal, change the directory to the folder that contains the installer, and run the following command:</p>
<pre><strong>sudo sh cuda_8.0.61_375.26_linux.run</strong></pre>
<p>In the command-line prompts, you will see the <span class="packt_screen">End User License Agreement</span>:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="387" width="679" class=" image-border" src="assets/872a1f18-381e-4d0c-80cf-703623ea1dec.png"/></div>
<p>You can use your arrow keys to navigate through the agreement. Otherwise, you can press <kbd>:q</kbd> and see the following screen:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="392" width="688" class=" image-border" src="assets/efc0ed88-6b4d-4bc2-b982-f72ccf874029.png"/></div>
<p>Now, you can type <kbd>accept</kbd> to accept the agreement. After that, you will need to answer some questions, as shown on the following screen:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="448" width="657" class=" image-border" src="assets/7b8c4d9d-c4b2-4bb2-a91c-c079f616c9af.png"/></div>
<p>You may notice that we will not install Nvidia drivers in this prompt since we already installed the latest driver in the previous section. When the installation completes, you will see a screen like this:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="447" width="660" class=" image-border" src="assets/b1c2b4cf-a905-4f62-b289-a2912cc977b9.png"/></div>
<p>Now, open your <kbd>~/.bashrc</kbd> file and add the following line at the end of the file:</p>
<pre>    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64/ </pre>
<p>We have successfully installed the CUDA toolkit into the machine. You can try the following command to see your graphic card information:</p>
<pre><strong>nvidia-smi</strong></pre>
<p>The result on our machine looks like this:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/90d6ad8c-34e9-41c3-b376-4a7097a8fefd.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing cuDNN</h1>
                </header>
            
            <article>
                
<p>In order to use TensorFlow with GPU support, you need to install another library from Nvidia named cuDNN. First, you need to navigate the Nvidia website and download the cuDNN library from <a href="https://developer.nvidia.com/cudnn"><span class="URLPACKT">https://developer.nvidia.com/cudnn</span></a>.</p>
<p>You may need to register a new Nvidia account. After you have logged in to the Nvidia website and opened the cuDNN link, you will see the following screen:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="355" width="680" class=" image-border" src="assets/6d09350a-6255-47f9-9034-bbd574370c69.png"/></div>
<p>As you can see, cuDNN has several versions, and we will use the <span class="packt_screen">cuDNN v5.1 for CUDA 8.0</span>, which is the cuDNN version required by TensorFlow. Now, you can download the library by clicking the <span class="packt_screen">cuDNN v5.1 Library for Linux</span> link:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="135" width="319" class=" image-border" src="assets/5102b30e-92af-46be-b758-8622bc461b27.png"/></div>
<p>You can continue with your terminal and use the following commands to install cuDNN on your machine:</p>
<pre><strong>tar -xf cudnn-8.0-linux-x64-v5.1.tgz </strong>
<strong>cd cuda</strong>
<strong>sudo cp -P include/cudnn.h /usr/include/</strong>
<strong>sudo cp -P lib64/libcudnn* /usr/lib/x86_64-linux-gnu/</strong>
<strong>sudo chmod a+r /usr/lib/x86_64-linux-gnu/libcudnn*</strong></pre>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/b48bf58c-331f-44b9-b3a3-b57d3dda36bb.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing TensorFlow</h1>
                </header>
            
            <article>
                
<p>With everything set up, we can easily install TensorFlow with GPU support with the <kbd>pip</kbd> tool, as follows:</p>
<pre><strong>sudo pip install tensorflow-gpu</strong></pre>
<p>The result of the command should look like this:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/6200f88d-3648-4916-9df9-410290042383.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Verifying TensorFlow with GPU support</h1>
                </header>
            
            <article>
                
<p>Now, you can type <kbd>python</kbd> on your command line and type the following Python command to see if TensorFlow can see your GPU:</p>
<pre>    import tensorflow as tf 
    tf.Session()</pre>
<p>The result should look like the following image:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="323" width="463" class=" image-border" src="assets/2792737f-39c4-4046-b215-71fa26cda670.png"/></div>
<p>Congratulations! TensorFlow can work with your GPU now. Our GPU is recognized as GeForce GTX TITAN X with 11.92 GB of memory. In the next section, we will show you the recommended approach to working with multiple versions of TensorFlow and libraries such as OpenCV.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using TensorFlow with Anaconda</h1>
                </header>
            
            <article>
                
<p>During your work, you will encounter situations where you need multiple versions of TensorFlow on the same machine, such as TensorFlow 1.0 or TensorFlow 1.2. We may need to use TensorFlow with Python 2.7 or 3.0. With the previous installation, we have already successfully installed TensorFlow in the system Python. Now, we will show you how to use Anaconda to have multiple working environments on the same machine. With Anaconda, we can even use different versions of other popular libraries, such as <kbd>OpenCV</kbd>, <kbd>NumPy</kbd>, and <kbd>scikit-learn</kbd>.</p>
<p>First, we need to download and install miniconda from <a href="https://conda.io/miniconda.html">https://conda.io/miniconda.html</a>. In our case, we select Python 2.7 64-bit bash installer, as we want to use Python 2.7 as the default Python. Nevertheless, we can create environments with either Python 2.7 or Python 3 later. We need to run the following command to run the installer:</p>
<pre><strong>bash Miniconda3-latest-Linux-x86_64.sh</strong></pre>
<p>We need to accept the <span class="packt_screen">End User License Agreement</span>:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/e89fa46b-42bf-4c8b-9544-40630acc9302.png"/></div>
<p>After that, we can continue the installation. The result should look like this:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/a6a45924-30c4-4fbf-b20e-8003eddd2341.png"/></div>
<p>Finally, we need to source the <kbd>.bashrc</kbd> file to get Anaconda up and running:</p>
<pre><strong>source ~/.bashrc</strong></pre>
<p>In the source code of this chapter, we have already provided some environment configurations that you can use to create your desired environment.</p>
<p>Here is an environment that uses Python 2.7, OpenCV 3, and TensorFlow 1.2.1 with GPU support. The configuration is named <kbd>env2.yml</kbd>:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="462" width="655" class=" image-border" src="assets/95bb8acd-3cd0-477e-b054-e5d846d3b5c6.png"/></div>
<p>You can easily change <kbd>python=2.7</kbd> to <kbd>python=3</kbd> and <kbd>opencv3</kbd> to <kbd>opencv</kbd> to have Python 3 and OpenCV 2.4 respectively.</p>
<p>Now, let's run the following command to create the environment:</p>
<pre><strong>conda env create -f env2.yml</strong></pre>
<p>The result should look like following:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img class=" image-border" src="assets/1331d6e0-36b3-49d9-b7ca-4d2eedb99c03.png"/></div>
<p>Next, you can type <kbd>source activate env2</kbd> to activate the environment.</p>
<p>Finally, we will need to verify TensorFlow, as before:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="477" width="666" class=" image-border" src="assets/2155a240-7872-4dde-b0a8-e4cfcb38a84a.png"/></div>
<p>You may notice the <span class="packt_screen">(env2)</span> in the top-left of the preceding image. That shows the name of the current environment. The Python version on the second line is 2.7.13 and is packaged by conda-forge.</p>
<p>Now, you can create several different environments to use in your workflow. Here is an example of an environment named <span class="packt_screen">env3</span> with Python 3 and OpenCV 2.4:</p>
<div class="packt_figure CDPAlignCenter CDPAlign"><img height="473" width="668" class=" image-border" src="assets/a8b0a9d6-22eb-471e-a9fe-f616c8381ebf.png"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we discussed the advantages of using GPUs in a machine learning workflow, especially in deep learning. Then, we showed the step-by-step installation of a Nvidia driver, the CUDA Toolkit, cuDNN, and TensorFlow with GPU support. We also introduced our recommended workflow for using multiple versions of TensorFlow and other libraries.</p>


            </article>

            
        </section>
    </body></html>